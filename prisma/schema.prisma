generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MembershipRole {
  ADMIN
  STAFF
  VIEWER
}

enum SubscriptionPlan {
  STARTER
  PRO
  BUSINESS
}

enum CaseStatus {
  NEW
  NEEDS_INFO
  READY_TO_SUBMIT
  SUBMITTED
  APPROVED
  DENIED
  CREDIT_RECEIVED
  CLOSED
}

enum EvidenceType {
  RECEIPT
  PHOTO
  INVOICE
  OTHER
}

enum CaseEventType {
  CASE_CREATED
  CASE_UPDATED
  STATUS_CHANGED
  EVIDENCE_UPLOADED
  TEMPLATE_APPLIED
  TEMPLATE_UPDATED
  IMPORT_CREATED
  IMPORT_COMPLETED
  NOTE_ADDED
}

enum ImportJobStatus {
  PENDING
  READY
  PROCESSING
  COMPLETED
  FAILED
}

enum ImportDedupeMode {
  SKIP
  UPDATE
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String       @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  memberships      Membership[]
  accounts         Account[]
  sessions         Session[]
  evidenceUploads  EvidenceFile[]   @relation("EvidenceUploadedBy")
  caseEvents       CaseEvent[]      @relation("CaseEventActor")
  assignedCases    Case[]           @relation("CaseAssignee")
  completedSteps   CaseChecklistItem[] @relation("ChecklistCompletedBy")
  importJobs       ImportJob[]      @relation("ImportCreatedBy")

  @@index([createdAt])
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  timezone  String   @default("America/New_York")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships    Membership[]
  subscription   Subscription?
  vendors        Vendor[]
  templates      VendorTemplate[]
  cases          Case[]
  checklistItems CaseChecklistItem[]
  evidenceFiles  EvidenceFile[]
  caseEvents     CaseEvent[]
  importJobs     ImportJob[]

  @@index([createdAt])
}

model Membership {
  id        String         @id @default(cuid())
  userId    String
  orgId     String
  role      MembershipRole
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([orgId, role])
}

model Subscription {
  id                   String           @id @default(cuid())
  orgId                String           @unique
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  status               String           @default("incomplete")
  plan                 SubscriptionPlan @default(STARTER)
  currentPeriodEnd     DateTime?
  trialEndsAt          DateTime?
  cancelAtPeriodEnd    Boolean          @default(false)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([status, plan])
}

model Vendor {
  id           String   @id @default(cuid())
  orgId        String
  name         String
  contactEmail String?
  portalUrl    String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  org       Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  templates VendorTemplate[]
  cases     Case[]

  @@unique([orgId, name])
  @@index([orgId])
}

model VendorTemplate {
  id             String   @id @default(cuid())
  orgId          String
  vendorId       String
  name           String
  steps          Json
  requiredFields Json
  slaDays        Int      @default(14)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  org    Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  vendor Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  cases  Case[]

  @@index([orgId, vendorId])
}

model Case {
  id                   String     @id @default(cuid())
  orgId                String
  vendorId             String
  templateId           String?
  assignedToUserId     String?
  status               CaseStatus @default(NEW)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  dueDate              DateTime?
  purchaseDate         DateTime?
  returnDate           DateTime?
  receiptId            String?
  sku                  String?
  upc                  String?
  brand                String?
  model                String?
  serialNumber         String?
  qty                  Int        @default(1)
  unitCost             Decimal?   @db.Decimal(10, 2)
  expectedCredit       Decimal?   @db.Decimal(10, 2)
  actualCredit         Decimal?   @db.Decimal(10, 2)
  customerReturnReason String?
  internalNotes        String?

  org           Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  vendor        Vendor             @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  template      VendorTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  assignedTo    User?              @relation("CaseAssignee", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  evidenceFiles EvidenceFile[]
  events        CaseEvent[]
  checklist     CaseChecklistItem[]
  importRows    ImportRow[]

  @@index([orgId, status])
  @@index([orgId, dueDate])
  @@index([orgId, vendorId])
  @@unique([orgId, receiptId, sku, returnDate])
  @@map("cases")
}

model CaseChecklistItem {
  id                String   @id @default(cuid())
  orgId             String
  caseId            String
  stepId            String
  title             String
  description       String?
  required          Boolean  @default(true)
  fieldsNeeded      Json
  defaultDueDays    Int?
  completedAt       DateTime?
  completedByUserId String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  case        Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  completedBy User?        @relation("ChecklistCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)

  @@unique([caseId, stepId])
  @@index([orgId, caseId])
}

model EvidenceFile {
  id               String       @id @default(cuid())
  orgId            String
  caseId           String
  type             EvidenceType
  filename         String
  url              String
  mimeType         String
  size             Int
  uploadedByUserId String
  createdAt        DateTime     @default(now())

  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  case       Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  uploadedBy User         @relation("EvidenceUploadedBy", fields: [uploadedByUserId], references: [id], onDelete: Restrict)

  @@index([orgId, caseId])
}

model CaseEvent {
  id          String        @id @default(cuid())
  orgId       String
  caseId      String
  type        CaseEventType
  message     String
  metadata    Json?
  createdAt   DateTime      @default(now())
  actorUserId String?

  org   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  case  Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  actor User?        @relation("CaseEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([orgId, caseId, createdAt])
}

model ImportJob {
  id               String          @id @default(cuid())
  orgId            String
  status           ImportJobStatus @default(PENDING)
  originalFilename String
  mapping          Json?
  dedupeMode       ImportDedupeMode @default(SKIP)
  previewRows      Json?
  createdByUserId  String?
  createdAt        DateTime        @default(now())
  completedAt      DateTime?
  error            String?

  org       Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  createdBy User?        @relation("ImportCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  rows      ImportRow[]

  @@index([orgId, status, createdAt])
}

model ImportRow {
  id         String   @id @default(cuid())
  importJobId String
  raw        Json
  parsed     Json?
  linkedCaseId String?
  action     String?
  error      String?
  createdAt  DateTime @default(now())

  importJob ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  linkedCase Case?    @relation(fields: [linkedCaseId], references: [id], onDelete: SetNull)

  @@index([importJobId])
}

model StripeEvent {
  id          String   @id
  type        String
  processedAt DateTime @default(now())
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
